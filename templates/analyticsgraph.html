{% extends 'analytics.html' %}
{% block analytics_graphicalview %}
<div style="width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem;">
  <div class="inv-navbar-right">
    <select id="hourSelect" class="inv-select">
      <option value="1 Hr">1 Hr</option>
      <option value="4 Hr">4 Hr</option>
      <option value="8 Hr">8 Hr</option>
      <option value="12 Hr">12 Hr</option>
      <option value="24 Hr">24 Hr</option>
      <option value="Custom">Custom</option>
    </select>

    <div class="date-filter">
      <span>From:</span>
      <input type="datetime-local" id="fromDate" class="inv-input">
    </div>
    <div class="date-filter">
      <span>To:</span>
      <input type="datetime-local" id="toDate" class="inv-input">
    </div>

    <button id="viewBtnGraph" class="inv-button">View</button>
    <span id="totalLabelKg" class="total-label-kg">Total Loss (in Kg): --</span>
    <span id="totalLabelPercent" class="total-label-percent">Total Loss (in %): --</span>
  </div>
</div>

<div class="graph-container">
  <div class="upper" id="graphKg"></div>
  <div class="lower" id="graphPer"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /***************************************
   * FORCE WHITE BACKGROUND
   ***************************************/
  Chart.register({
    id: "whiteBackground",
    beforeDraw: (chart) => {
      const ctx = chart.canvas.getContext("2d");
      ctx.save();
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, chart.width, chart.height);
      ctx.restore();
    }
  });

  /***************************************
   * ELEMENTS
   ***************************************/
  const hourSelect = document.getElementById("hourSelect");
  const fromDate = document.getElementById("fromDate");
  const toDate = document.getElementById("toDate");
  const viewBtn = document.getElementById("viewBtnGraph");
  const totalKg = document.getElementById("totalLabelKg");
  const totalPer = document.getElementById("totalLabelPercent");

  const ctxKg = document.createElement("canvas");
  const ctxPer = document.createElement("canvas");
  document.getElementById("graphKg").appendChild(ctxKg);
  document.getElementById("graphPer").appendChild(ctxPer);

  let chartKg, chartPer;

  /***************************************
   * RESTORE SESSION (Chart + Filters)
   ***************************************/
  function restoreGraphSession() {
    const savedFilters = JSON.parse(localStorage.getItem("analytics_graph_filters"));
    const savedCategories = JSON.parse(localStorage.getItem("analytics_graph_categories"));
    const savedErrorKg = JSON.parse(localStorage.getItem("analytics_graph_errorKg"));
    const savedErrorPer = JSON.parse(localStorage.getItem("analytics_graph_errorPer"));
    const savedTotalKg = localStorage.getItem("analytics_graph_totalKg");
    const savedTotalPer = localStorage.getItem("analytics_graph_totalPer");

    if (savedFilters) {
      hourSelect.value = savedFilters.hours;
      fromDate.value = savedFilters.from_time;
      toDate.value = savedFilters.to_time;
    }

    if (savedCategories && savedErrorKg && savedErrorPer) {
      rebuildCharts(savedCategories, savedErrorKg, savedErrorPer);

      totalKg.textContent = `Total Loss (in Kg): ${savedTotalKg}`;
      totalPer.textContent = `Total Loss (in %): ${savedTotalPer}`;
    }
  }

  restoreGraphSession();

  /***************************************
   * VIEW BUTTON â†’ FETCH DATA + SAVE SESSION
   ***************************************/
  viewBtn.addEventListener("click", async () => {
    const hours = hourSelect.value;
    const from_time = fromDate.value;
    const to_time = toDate.value;

    const res = await fetch("/api/analytics/graph/data", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ hours, from_time, to_time })
    });

    const result = await res.json();
    if (result.error) {
      alert(result.error);
      return;
    }

    const data = result.data;
    if (!data || data.length === 0) {
      alert("No data found for this range");
      return;
    }

    const categories = data.map(d => d["Category"]);
    const errorKg = data.map(d => d["Error_Kg"]);
    const errorPer = data.map(d => d["Error_%"]);

    rebuildCharts(categories, errorKg, errorPer);

    totalKg.textContent = `Total Loss (in Kg): ${result.total_error_kg}`;
    totalPer.textContent = `Total Loss (in %): ${result.total_error_per}`;

    /***************************************
     * SAVE SESSION DATA
     ***************************************/
    localStorage.setItem("analytics_graph_filters",
      JSON.stringify({ hours, from_time, to_time })
    );

    localStorage.setItem("analytics_graph_categories", JSON.stringify(categories));
    localStorage.setItem("analytics_graph_errorKg", JSON.stringify(errorKg));
    localStorage.setItem("analytics_graph_errorPer", JSON.stringify(errorPer));
    localStorage.setItem("analytics_graph_totalKg", result.total_error_kg);
    localStorage.setItem("analytics_graph_totalPer", result.total_error_per);
  });

  /***************************************
   * REBUILD CHARTS FUNCTION
   ***************************************/
  function rebuildCharts(categories, errorKg, errorPer) {

    if (chartKg) chartKg.destroy();
    if (chartPer) chartPer.destroy();

    // KG Chart
    chartKg = new Chart(ctxKg, {
      type: "bar",
      data: {
        labels: categories,
        datasets: [{
          label: "Error (Kg)",
          data: errorKg,
          backgroundColor: "#2196F3"
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { title: { display: true, text: "Total Error (Kg) per Silo" } }
      }
    });

    // PERCENT Chart
    chartPer = new Chart(ctxPer, {
      type: "bar",
      data: {
        labels: categories,
        datasets: [{
          label: "Error (%)",
          data: errorPer,
          backgroundColor: "#2196F3"
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { title: { display: true, text: "Total Error (%) per Silo" } }
      }
    });
  }

});
</script>

{% endblock %}
