{% extends 'base.html' %}
{% block content %}

<div class="inv-navbar recipe">
  <div class="inv-navbar-left recipe">
    <span class="inv-app-title">Recipe List</span>
    <div class="list-opt">
      <button class="icon-button" id="importBtn" {% if not user_logged_in or role == 'operator' %} disabled title="Access Denied" {% endif %} title="Import"><i class="bx bx-import"></i></button>
      <button class="icon-button" id="exportBtn" {% if not user_logged_in or role == 'operator' %} disabled title="Access Denied" {% endif %} title="Export"><i class="bx bx-export"></i></button>
    </div>
  </div>

  <div class="inv-navbar-right recipe">
    <div class="table-opt">
      <button class="add-btn" id="addRowRecipe" {% if not user_logged_in or role == 'operator' %} disabled title="Access Denied" {% endif %}>Add</button>

      <div style="display:flex;gap:0.2rem;align-items:center;">
        <span style="font-weight:600;">Selected Recipe:</span>
        <span id="selectedRecipeLabel"
          style="background:#fff;border:1px solid #aaa;padding:0.3rem 0.5rem;border-radius:0.2rem;">--</span>
      </div>

      <button class="icon-button" {% if not user_logged_in or role == 'operator' %} disabled title="Access Denied" {% endif %} title="Download"><i class="bx bxs-download"></i></button>
    </div>
  </div>
</div>

<div class="recipe-content">

  <!---------------- LEFT TREE PANEL ---------------->
  <div class="left">
    <div class="search-bar">
      <input type="text" id="searchRecipe" placeholder="Searchâ€¦" class="search-input">
    </div>

    <div class="tree-actions">

      <i class='bx bx-file-blank add-icon 
          {% if not user_logged_in or role == 'operator' %} disabled-icon {% endif %}'
          title="{% if not user_logged_in or role == 'operator' %}Access Denied{% else %}Add Recipe{% endif %}"
          id="addRecipeIcon">
      </i>

      <i class='bx bx-trash delete-icon 
          {% if not user_logged_in or role == 'operator' %} disabled-icon {% endif %}'
          title="{% if not user_logged_in or role == 'operator' %}Access Denied{% else %}Delete Recipe{% endif %}"
          id="deleteRecipe">
      </i>

    </div>


    <div class="tree-view">
      <ul class="tree-root">
        <li class="folder-node expanded">
          <i class="bx bx-folder-open"></i>
          <span>Recipes</span>
        </li>
        <ul class="child-list" id="childRecipes" role="tree"></ul>
      </ul>
    </div>
  </div>

  <!---------------- RIGHT TABLE PANEL ---------------->
  <div class="right">
    <div id="recipeTableContainer">
      <p class="placeholder">Select a recipe from the left to view details.</p>
    </div>
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const childList = document.getElementById("childRecipes");
  const selectedLabel = document.getElementById("selectedRecipeLabel");
  const tableContainer = document.getElementById("recipeTableContainer");
  const searchInput = document.getElementById("searchRecipe");

  const addRecipeIcon = document.getElementById("addRecipeIcon");
  const deleteRecipeBtn = document.getElementById("deleteRecipe");
  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");

  /* ---------------- LOAD RECIPES ---------------- */
  async function loadRecipes() {
    const res = await fetch("/api/recipes_data/get_recipes");
    const data = await res.json();
    renderTree(data);
  }
  /* =====================================================
   UNIVERSAL SORTING LOGIC (ASC + DESC)
===================================================== */
  let recipeSortState = {};

  function enableRecipeSorting(table) {
      const head = table.querySelector("thead");
      const body = table.querySelector("tbody");

      if (!head || !body) return;

      const headers = head.querySelectorAll("th");

      headers.forEach((th, colIndex) => {
          th.style.cursor = "pointer";

          th.addEventListener("click", () => sortRecipeTable(body, colIndex));
      });
  }

  function sortRecipeTable(body, colIndex) {

      let rows = Array.from(body.querySelectorAll("tr"));
      recipeSortState[colIndex] = recipeSortState[colIndex] === "asc" ? "desc" : "asc";

      rows.sort((a, b) => {
          let aVal = a.children[colIndex]?.innerText.trim() || "";
          let bVal = b.children[colIndex]?.innerText.trim() || "";

          // Auto numeric detection
          const isNumeric = !isNaN(parseFloat(aVal)) && !isNaN(parseFloat(bVal));

          if (isNumeric) {
              aVal = parseFloat(aVal) || 0;
              bVal = parseFloat(bVal) || 0;
          }

          if (recipeSortState[colIndex] === "asc") {
              return aVal > bVal ? 1 : -1;
          } else {
              return aVal < bVal ? 1 : -1;
          }
      });

      // Re-render table
      body.innerHTML = "";
      rows.forEach(r => body.appendChild(r));
  }

  function renderTree(data) {
    childList.innerHTML = "";

    if (!data.length) {
      childList.innerHTML = `<li class="no-data">No recipes found</li>`;
      return;
    }

    data.forEach(r => {
      const li = document.createElement("li");
      li.className = "file-node";
      li.dataset.id = r.id;
      li.dataset.name = r.name;

      li.innerHTML = `<i class='bx bx-file'></i><span>${r.name}</span>`;

      li.addEventListener("click", () => selectRecipe(r));
      li.addEventListener("dblclick", () => renameRecipe(r));

      childList.appendChild(li);
    });
  }

  /* ---------------- SELECT RECIPE ---------------- */
  async function selectRecipe(recipe) {
    document.querySelectorAll(".file-node").forEach(x => x.classList.remove("active"));
    const node = document.querySelector(`.file-node[data-id='${recipe.id}']`);
    if (node) node.classList.add("active");

    selectedLabel.textContent = recipe.name;

    const res = await fetch(`/api/recipes/${encodeURIComponent(recipe.name)}/table`);
    const rows = await res.json();

    if (!rows.length) {
      tableContainer.innerHTML =
        `<p class="placeholder">No data found for <b>${recipe.name}</b>.</p>`;
      return;
    }

    tableContainer.innerHTML = "";
    tableContainer.appendChild(buildTable(recipe.name, rows));
  }

  /* ---------------- BUILD TABLE ---------------- */
  function buildTable(category, rows) {

      const wrapper = document.createElement("div");

      const table = document.createElement("table");
      table.className = "data-table";

      table.innerHTML = `
        <thead>
          <tr>
            <th style="display:none;">Index</th>
            <th>Silo No</th>
            <th>Material Name</th>
            <th>Set Weight(Kg)</th>
            <th>Fine Weight(Kg)</th>
            <th>Tolerance(kg)</th>
            <th>Action</th>
          </tr>
        </thead>

        <tbody id="recipeTableBody">
          ${rows.map(r => `
            <tr data-index="${r.Index}" data-category="${category}">
              <td style="display:none;">${r.Index}</td>
              <td>${r.SiloNo}</td>
              <td>${r.MaterialName}</td>
              <td>${r.SetWeight}</td>
              <td>${r.FineWeight}</td>
              <td>${r.Tolerance}</td>
              <td class="action-cell">
                <button class="table-action-btn edit-btn" {% if not user_logged_in or role == 'operator' %} disabled title="Access Denied" {% endif %}><i class="bx bx-edit"></i></button>
                <button class="table-action-btn delete-btn" {% if not user_logged_in or role == 'operator' %} disabled title="Access Denied" {% endif %}><i class="bx bx-trash"></i></button>
              </td>
            </tr>
          `).join("")}
        </tbody>
      `;

      wrapper.appendChild(table);

      /* ðŸ”¥ Enable Sorting for this recipe table */
      setTimeout(() => enableRecipeSorting(table), 10);

      return wrapper;
  }

  /* ---------------- ADD ROW ---------------- */
  document.getElementById("addRowRecipe").addEventListener("click", () => {

    const category = selectedLabel.textContent.trim();
    if (category === "--") return alert("Select a recipe first.");

    const tbody = document.getElementById("recipeTableBody");
    if (!tbody) return;

    const tr = document.createElement("tr");
    tr.className = "new-row";

    tr.innerHTML = `
      <td><input class="edit-input silo"></td>
      <td><input class="edit-input material" disabled></td>
      <td><input class="edit-input set"></td>
      <td><input class="edit-input fine"></td>
      <td><input class="edit-input tol"></td>
      <td class="action-cell">
        <button class="table-action-btn save-new"><i class="bx bx-check"></i></button>
        <button class="table-action-btn cancel-new"><i class="bx bx-x"></i></button>
      </td>
    `;

    tbody.prepend(tr);

    const silo = tr.querySelector(".silo");
    const material = tr.querySelector(".material");

    silo.addEventListener("blur", async () => {
      if (!silo.value) return material.value = "";
      const d = await (await fetch(`/api/material/${silo.value}`)).json();
      material.value = d.success ? d.MaterialName : "";
    });

    tr.querySelector(".cancel-new").onclick = () => tr.remove();

    tr.querySelector(".save-new").onclick = async () => {

      if (!silo.value.trim()) return alert("Silo required.");

      const set = Number(tr.querySelector(".set").value);
      const fine = Number(tr.querySelector(".fine").value);
      const tol = Number(tr.querySelector(".tol").value);

      // âœ… Validation for FineWeight & Tolerance
      if (fine > set) return alert("âŒ Fine Weight must be â‰¤ Set Weight!");
      if (tol > set) return alert("âŒ Tolerance must be â‰¤ Set Weight!");

      const matRes = await fetch(`/api/material/${silo.value}`);
      const matJson = await matRes.json();

      if (!matJson.success) return alert("âŒ Invalid Silo Number.");

      const payload = {
        SiloNo: silo.value.trim(),
        SetWeight: set,
        FineWeight: fine,
        Tolerance: tol,
        Category: category
      };

      const res = await fetch("/api/recipes_data/add_row", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const result = await res.json();

      if (!result.success) {
        if (result.error === "silo_already_exists")
          return alert("âŒ This SiloNo already exists in this recipe!");

        if (result.error === "silo_not_found")
          return alert("âŒ SiloNo not found in MaterialData!");

        return alert("âŒ Add failed: " + result.error);
      }

      selectRecipe({ id: 0, name: category });
    };


  }); // âœ… FIXED CLOSING BRACE

  /* ---------------- EDIT ROW ---------------- */
  document.addEventListener("click", async (e) => {

    if (e.target.closest(".edit-btn")) {

      const row = e.target.closest("tr");
      if (row.classList.contains("editing")) return;

      row.classList.add("editing");

      const tds = row.querySelectorAll("td");
      const silo = tds[1].innerText.trim();
      const mat = tds[2].innerText.trim();

      tds[1].innerHTML = `<input class="edit-input edit-silo" value="${silo}">`;
      tds[2].innerHTML = `<input class="edit-input edit-material" value="${mat}" disabled>`;
      tds[3].innerHTML = `<input class="edit-input edit-set" value="${tds[3].innerText}">`;
      tds[4].innerHTML = `<input class="edit-input edit-fine" value="${tds[4].innerText}">`;
      tds[5].innerHTML = `<input class="edit-input edit-tol" value="${tds[5].innerText}">`;

      tds[6].innerHTML = `
        <button class="table-action-btn save-edit"><i class="bx bx-check"></i></button>
        <button class="table-action-btn cancel-edit"><i class="bx bx-x"></i></button>
      `;

      const siloInput = tds[1].querySelector(".edit-silo");
      const matInput = tds[2].querySelector(".edit-material");

      siloInput.addEventListener("blur", async () => {
        if (!siloInput.value) return matInput.value = "";
        const d = await (await fetch(`/api/material/${siloInput.value}`)).json();
        matInput.value = d.success ? d.MaterialName : "";
      });

      tds[6].querySelector(".cancel-edit").onclick = () =>
        selectRecipe({ id: row.dataset.index, name: row.dataset.category });

      tds[6].querySelector(".save-edit").onclick = async () => {

        const set = Number(tds[3].querySelector(".edit-set").value);
        const fine = Number(tds[4].querySelector(".edit-fine").value);
        const tol = Number(tds[5].querySelector(".edit-tol").value);

        // âœ… Validation for FineWeight & Tolerance
        if (fine > set) return alert("âŒ Fine Weight must be â‰¤ Set Weight!");
        if (tol > set) return alert("âŒ Tolerance must be â‰¤ Set Weight!");

        const siloInput = tds[1].querySelector(".edit-silo");

        const matRes = await fetch(`/api/material/${siloInput.value}`);
        const matJson = await matRes.json();

        if (!matJson.success) return alert("âŒ Invalid Silo Number!");

        const payload = {
          SiloNo: siloInput.value.trim(),
          Category: row.dataset.category,
          SetWeight: set,
          FineWeight: fine,
          Tolerance: tol
        };

        const res = await fetch(`/api/recipes_data/update_row/${row.dataset.index}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const json = await res.json();

        if (!json.success) {

          if (json.error === "silo_already_exists")
            return alert("âŒ This SiloNo already exists in this recipe!");

          if (json.error === "silo_not_found")
            return alert("âŒ Silo not found in MaterialData!");

          return alert("âŒ Update error: " + json.error);
        }

        selectRecipe({ id: row.dataset.index, name: row.dataset.category });
      };

    }

    /* ---------------- DELETE ROW ---------------- */
    if (e.target.closest(".delete-btn")) {

      const row = e.target.closest("tr");

      if (!confirm("Delete this row?")) return;

      const res = await fetch(`/api/recipes_data/delete_row/${row.dataset.index}`, {
        method: "DELETE"
      });

      const json = await res.json();

      if (json.success) row.remove();
      else alert("âŒ Delete failed.");
    }

  });

  /* ---------------- RENAME RECIPE ---------------- */
  async function renameRecipe(recipe) {
    const newName = prompt("Rename recipe:", recipe.name);
    if (!newName || newName.trim() === recipe.name) return;

    const res = await fetch("/api/recipes_data/rename_recipe", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ old_name: recipe.name, new_name: newName.trim() })
    });

    if ((await res.json()).success) {
      await loadRecipes();
      setTimeout(() =>
        selectRecipe({ id: recipe.id, name: newName.trim() }), 150);
    }
  }

  /* ---------------- ADD RECIPE ---------------- */
  async function addRecipe() {
    const name = prompt("Enter new recipe name:");
    if (!name) return;

    await fetch("/api/recipes_data/add_recipe", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name })
    });

    loadRecipes();
  }
  
  importBtn.addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".xlsx";

      input.onchange = () => {
          const file = input.files[0];
          if (!file) return;

          const formData = new FormData();
          formData.append("file", file);

          fetch("/api/recipes/import", {
              method: "POST",
              body: formData
          })
          .then(res => res.json())
          .then(json => {
              if (json.success) {
                  alert("âœ… Imported successfully!");
                  loadRecipes();   // refresh tree
              } else {
                  alert("âŒ Import failed: " + json.error);
              }
          })
          .catch(err => alert("âŒ Error: " + err));
      };

      input.click();
  });
  
  exportBtn.addEventListener("click", async () => {
      const category = document.getElementById("selectedRecipeLabel").textContent.trim();

      if (category === "--") {
          return alert("Please select a recipe to export.");
      }

      const res = await fetch("/api/recipes/export", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ category })
      });

      if (!res.ok) {
          const error = await res.json();
          return alert(error.error || "Export failed");
      }

      // Download Excel
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `${category}.xlsx`;
      a.click();

      window.URL.revokeObjectURL(url);
  });
  /* ---------------- DELETE RECIPE ---------------- */
  async function deleteSelectedRecipe() {
    const active = document.querySelector(".file-node.active");
    if (!active) return alert("Select a recipe first.");

    const name = active.dataset.name;

    if (!confirm(`Delete "${name}"?`)) return;

    await fetch(`/api/recipes_data/delete_recipe/${encodeURIComponent(name)}`, {
      method: "DELETE"
    });

    loadRecipes();
    selectedLabel.textContent = "--";
    tableContainer.innerHTML = `<p class="placeholder">Recipe deleted.</p>`;
  }

  searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase();
    document.querySelectorAll(".file-node").forEach(n => {
      n.style.display = n.dataset.name.toLowerCase().includes(q) ? "" : "none";
    });
  });

  addRecipeIcon.addEventListener("click", addRecipe);
  deleteRecipeBtn.addEventListener("click", deleteSelectedRecipe);

  loadRecipes();
});
</script>

{% endblock %}
