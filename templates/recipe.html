{% extends 'base.html' %}
{% block content %}

<div class="inv-navbar recipe">
  <div class="inv-navbar-left recipe">
    <span class="inv-app-title">Recipe List</span>
    <div class="list-opt">
      <button class="icon-button" id="importBtn" title="Import"><i class="bx bx-import"></i></button>
      <button class="icon-button" id="exportBtn" title="Export"><i class="bx bx-export"></i></button>
    </div>
  </div>

  <div class="inv-navbar-right recipe">
    <div class="table-opt">

      <!-- ADD ROW (This is now the ONLY Add Row button) -->
      <button class="add-btn" id="addRowRecipe">Add</button>

      <div style="display:flex;gap:0.2rem;align-items:center;">
        <span style="font-weight:600;">Selected Recipe:</span>
        <span id="selectedRecipeLabel"
          style="background:#fff;border:1px solid #aaa;padding:0.3rem 0.5rem;border-radius:0.2rem;">--</span>
      </div>


      <button class="icon-button" title="Download"><i class="bx bxs-download"></i></button>
    </div>
  </div>
</div>


<div class="recipe-content">

  <!---------------- LEFT TREE PANEL ---------------->
  <div class="left">

    <div class="search-bar">
      <input type="text" id="searchRecipe" placeholder="Search…" class="search-input">
    </div>

    <div class="tree-actions">
      <i class='bx bx-file-blank add-icon' title="Add Recipe" id="addRecipeIcon"></i>
      <i class='bx bx-trash delete-icon' title="Delete Recipe" id="deleteRecipe"></i>
    </div>

    <div class="tree-view">
      <ul class="tree-root">

        <li class="folder-node expanded">
          <i class="bx bx-folder-open"></i>
          <span>Recipes</span>
        </li>

        <ul class="child-list" id="childRecipes" role="tree"></ul>

      </ul>
    </div>

  </div>



  <!---------------- RIGHT TABLE PANEL ---------------->
  <div class="right">
    <div id="recipeTableContainer">
      <p class="placeholder">Select a recipe from the left to view details.</p>
    </div>
  </div>

</div>



<script>
document.addEventListener("DOMContentLoaded", () => {

  const childList = document.getElementById("childRecipes");
  const selectedLabel = document.getElementById("selectedRecipeLabel");
  const tableContainer = document.getElementById("recipeTableContainer");
  const searchInput = document.getElementById("searchRecipe");

  const addRecipeBtn = document.getElementById("addRecipe");
  const addRecipeIcon = document.getElementById("addRecipeIcon");
  const deleteRecipeBtn = document.getElementById("deleteRecipe");

  let recipesCache = [];

  /* ---------------- LOAD TREE ITEMS ---------------- */
  async function loadRecipes() {
    const res = await fetch("/api/recipes_data/get_recipes");
    recipesCache = await res.json();
    renderTree(recipesCache);
  }

  function renderTree(data) {
    childList.innerHTML = "";

    if (!data.length) {
      childList.innerHTML = `<li class="no-data">No recipes found</li>`;
      return;
    }

    data.forEach(r => {
      const li = document.createElement("li");
      li.className = "file-node";
      li.dataset.id = r.id;
      li.dataset.name = r.name;

      li.innerHTML = `<i class='bx bx-file'></i><span>${r.name}</span>`;

      li.addEventListener("click", () => selectRecipe(r));
      li.addEventListener("dblclick", () => renameRecipe(r));

      childList.appendChild(li);
    });
  }


  /* ---------------- SELECT RECIPE → LOAD TABLE ---------------- */
  async function selectRecipe(recipe) {
    document.querySelectorAll(".file-node").forEach(x => x.classList.remove("active"));
    const node = document.querySelector(`.file-node[data-id='${recipe.id}']`);
    if (node) node.classList.add("active");

    selectedLabel.textContent = recipe.name;

    const res = await fetch(`/api/recipes/${encodeURIComponent(recipe.name)}/table`);
    const rows = await res.json();

    if (!rows.length) {
      tableContainer.innerHTML = `<p class="placeholder">No data found for <b>${recipe.name}</b>.</p>`;
      return;
    }

    tableContainer.innerHTML = "";
    tableContainer.appendChild(buildTable(recipe.name, rows));
  }


  /* ---------------- BUILD TABLE (WITHOUT ADD ROW BUTTON) ---------------- */
 
  function buildTable(category, rows) {

    const wrapper = document.createElement("div");

    const table = document.createElement("table");
    table.className = "data-table";

    table.innerHTML = `
      <thead>
        <tr>
          <th class="index-col" style="display:none;">Index</th>
          <th>SiloNo</th>
          <th>MaterialName</th>
          <th>SetWeight(kg)</th>
          <th>FineWeight(kg)</th>
          <th>Tolerance(kg)</th>
          <th>Action</th>
        </tr>
      </thead>

      <tbody id="recipeTableBody">
        ${rows.map(r => `
          <tr data-index="${r.Index}" data-category="${category}">
            
            <!-- Hidden Index Column -->
            <td class="index-col" style="display:none;">${r.Index}</td>
            
            <td>${r.SiloNo}</td>
            <td>${r.MaterialName}</td>
            <td>${r.SetWeight}</td>
            <td>${r.FineWeight}</td>
            <td>${r.Tolerance}</td>

            <td class="action-cell">
              <button class="table-action-btn edit-btn"><i class="bx bx-edit"></i></button>
              <button class="table-action-btn delete-btn"><i class="bx bx-trash"></i></button>
            </td>
          </tr>
        `).join("")}
      </tbody>
    `;

    wrapper.appendChild(table);
    return wrapper;
  }




  /* ---------------- ADD ROW (TOP BUTTON) ---------------- */
  document.getElementById("addRowRecipe").addEventListener("click", () => {

    const category = selectedLabel.textContent.trim();
    if (category === "--") return alert("Select a recipe first.");

    const tbody = document.getElementById("recipeTableBody");
    if (!tbody) return;

    const tr = document.createElement("tr");
    tr.className = "new-row";

    tr.innerHTML = `
      <td><input class="edit-input silo" /></td>
      <td><input class="edit-input material" disabled /></td>
      <td><input class="edit-input set" /></td>
      <td><input class="edit-input fine" /></td>
      <td><input class="edit-input tol" /></td>
      <td class="action-cell">
        <button class="table-action-btn save-new"><i class="bx bx-check"></i></button>
        <button class="table-action-btn cancel-new"><i class="bx bx-x"></i></button>
      </td>
    `;

    tbody.prepend(tr);

    const silo = tr.querySelector(".silo");
    const material = tr.querySelector(".material");

    silo.addEventListener("blur", async () => {
      if (!silo.value) return material.value = "";
      const res = await fetch(`/api/material/${silo.value}`);
      const d = await res.json();
      material.value = d.success ? d.MaterialName : "";
    });

    tr.querySelector(".cancel-new").onclick = () => tr.remove();

    tr.querySelector(".save-new").onclick = async () => {
      if (!silo.value.trim()) return alert("Silo required.");

      const resMat = await fetch(`/api/material/${silo.value}`);
      const matJson = await resMat.json();

      if (!matJson.success) return alert("Invalid silo.");

      const payload = {
        SiloNo: silo.value.trim(),
        MaterialName: matJson.MaterialName,
        SetWeight: tr.querySelector(".set").value,
        FineWeight: tr.querySelector(".fine").value,
        Tolerance: tr.querySelector(".tol").value,
        Category: category
      };

      const res = await fetch("/api/recipes_data/add_row", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const result = await res.json();
      if (result.success) selectRecipe({ id: 0, name: category });
    };
  });


  /* ---------------- EDIT ROW ---------------- */
  document.addEventListener("click", async (e) => {

    if (e.target.closest(".edit-btn")) {
      const row = e.target.closest("tr");
      if (row.classList.contains("editing")) return;

      row.classList.add("editing");

      const tds = row.querySelectorAll("td");
      const silo = tds[1].innerText.trim();
      const mat = tds[2].innerText.trim();
      const set = tds[3].innerText.trim();
      const fine = tds[4].innerText.trim();
      const tol = tds[5].innerText.trim();

      tds[1].innerHTML = `<input class="edit-input edit-silo" value="${silo}">`;
      tds[2].innerHTML = `<input class="edit-input edit-material" value="${mat}" disabled>`;
      tds[3].innerHTML = `<input class="edit-input edit-set" value="${set}">`;
      tds[4].innerHTML = `<input class="edit-input edit-fine" value="${fine}">`;
      tds[5].innerHTML = `<input class="edit-input edit-tol" value="${tol}">`;

      tds[6].innerHTML = `
        <button class="table-action-btn save-edit"><i class="bx bx-check"></i></button>
        <button class="table-action-btn cancel-edit"><i class="bx bx-x"></i></button>
      `;

      const siloInput = tds[1].querySelector(".edit-silo");
      const matInput = tds[2].querySelector(".edit-material");

      siloInput.addEventListener("blur", async () => {
        if (!siloInput.value.trim()) return matInput.value = "";
        const d = await (await fetch(`/api/material/${siloInput.value}`)).json();
        matInput.value = d.success ? d.MaterialName : "";
      });

      tds[6].querySelector(".cancel-edit").onclick = () =>
        selectRecipe({ id: row.dataset.index, name: row.dataset.category });

      tds[6].querySelector(".save-edit").onclick = async () => {

        const resMat = await fetch(`/api/material/${siloInput.value}`);
        const matJson = await resMat.json();

        if (!matJson.success) return alert("Invalid silo.");

        const payload = {
          SiloNo: siloInput.value.trim(),
          MaterialName: matJson.MaterialName,
          SetWeight: tds[3].querySelector(".edit-set").value,
          FineWeight: tds[4].querySelector(".edit-fine").value,
          Tolerance: tds[5].querySelector(".edit-tol").value
        };

        const res = await fetch(`/api/recipes_data/update_row/${row.dataset.index}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if ((await res.json()).success)
          selectRecipe({ id: row.dataset.index, name: row.dataset.category });
      };
    }


    /* ---------------- DELETE ROW ---------------- */
    if (e.target.closest(".delete-btn")) {
      const row = e.target.closest("tr");
      if (!confirm("Delete this row?")) return;

      const res = await fetch(`/api/recipes_data/delete_row/${row.dataset.index}`, {
        method: "DELETE"
      });

      if ((await res.json()).success) row.remove();
    }
  });


  /* ---------------- RENAME RECIPE ---------------- */
  async function renameRecipe(recipe) {
    const newName = prompt("Rename recipe:", recipe.name);
    if (!newName || newName.trim() === recipe.name) return;

    const res = await fetch("/api/recipes_data/rename_recipe", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ old_name: recipe.name, new_name: newName.trim() })
    });

    if ((await res.json()).success) {
      await loadRecipes();
      setTimeout(() => selectRecipe({ id: recipe.id, name: newName.trim() }), 150);
    }
  }


  /* ---------------- ADD RECIPE ---------------- */
  async function addRecipe() {
    const name = prompt("Enter new recipe name:");
    if (!name) return;

    await fetch("/api/recipes_data/add_recipe", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name })
    });

    loadRecipes();
  }


  /* ---------------- DELETE RECIPE ---------------- */
  async function deleteSelectedRecipe() {
    const active = document.querySelector(".file-node.active");
    if (!active) return alert("Select a recipe first.");

    const name = active.dataset.name;
    if (!confirm(`Delete "${name}"?`)) return;

    await fetch(`/api/recipes_data/delete_recipe/${encodeURIComponent(name)}`, {
      method: "DELETE"
    });

    loadRecipes();
    selectedLabel.textContent = "--";
    tableContainer.innerHTML = `<p class="placeholder">Recipe deleted.</p>`;
  }


  /* ---------------- TREE SEARCH ---------------- */
  searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase();
    document.querySelectorAll(".file-node").forEach(n => {
      n.style.display = n.dataset.name.toLowerCase().includes(q) ? "" : "none";
    });
  });

  /* Bind top buttons */
  addRecipeBtn?.addEventListener("click", addRecipe);
  addRecipeIcon.addEventListener("click", addRecipe);
  deleteRecipeBtn.addEventListener("click", deleteSelectedRecipe);

  loadRecipes();
});
</script>

{% endblock %}
