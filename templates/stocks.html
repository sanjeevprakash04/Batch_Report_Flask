{% extends 'base.html' %}

{% block content %}
<div class="inv-navbar">
  <div class="inv-navbar-left">
    <span class="inv-app-title">Stocks</span>
  </div>

  <div class="inv-navbar-right">
    <button class="add-btn" id="addRowBtn" {% if not user_logged_in or role == 'operator' %} disabled title="Access Denied" {% endif %}>Add</button>
    <button class="add-btn" id="exportBtn" {% if not user_logged_in or role == 'operator' %} disabled title="Access Denied" {% endif %}>Export</button>
    <input class="search-input" type="text" id="searchBox" placeholder="Search...">
  </div>
</div>

<!-- TABLE -->
<div class="stocks-table-wrapper">
  <table class="stocks-table">
    <thead>
      <tr>
        <th class="sortable" data-col="0">Silo No</th>
        <th class="sortable" data-col="1">Raw Material Name</th>
        <th class="sortable" data-col="2">Raw Material Code</th>
        <th>Operator Name</th>
        <th class="sortable" data-col="4">Total Consumption (Kg)</th>
        <th>Action</th>
      </tr>
    </thead>

    <tbody id="stocksTableBody">
      <tr><td colspan="6" class="table-error">Loading data...</td></tr>
    </tbody>
  </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  const tableBody = document.getElementById("stocksTableBody");
  const addRowBtn = document.getElementById("addRowBtn");
  const exportBtn = document.getElementById("exportBtn");
  const searchBox = document.getElementById("searchBox");

  /* =========================================================
       SORTING LOGIC (FIXED)
  ========================================================= */
  let sortState = {};

  function sortTable(colIndex, numeric = false) {
    let rows = Array.from(tableBody.querySelectorAll("tr"));

    // Toggle sorting direction
    sortState[colIndex] = sortState[colIndex] === "asc" ? "desc" : "asc";

    rows.sort((a, b) => {
      let aVal = a.children[colIndex].innerText.trim();
      let bVal = b.children[colIndex].innerText.trim();

      if (numeric) {
        aVal = parseFloat(aVal) || 0;
        bVal = parseFloat(bVal) || 0;
      }

      if (sortState[colIndex] === "asc") return aVal > bVal ? 1 : -1;
      return aVal < bVal ? 1 : -1;
    });

    tableBody.innerHTML = "";
    rows.forEach(r => tableBody.appendChild(r));
  }

  document.querySelectorAll("th.sortable").forEach((th) => {
    const index = Number(th.dataset.col);

    th.addEventListener("click", () => {
      const numericCols = [0, 4];
      sortTable(index, numericCols.includes(index));
    });
  });

  /* =========================================================
       LOAD STOCK DATA
  ========================================================= */
  async function loadStocks() {
    const response = await fetch("/api/stocks");
    const data = await response.json();

    tableBody.innerHTML = "";

    if (!data.success || data.records.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="6" class="table-error">No records found</td></tr>`;
      return;
    }

    data.records.forEach(row => {
      const tr = document.createElement("tr");
      tr.dataset.silono = row.SiloNo;

      tr.innerHTML = `
        <td>${row.SiloNo}</td>
        <td>${row.MaterialName}</td>
        <td>${row.MaterialCode}</td>
        <td>${row.OperatorName}</td>
        <td>${row.TotalExtracted}</td>

        <td class="action-cell">
          <button class="table-action-btn edit-btn"
            {% if not user_logged_in or role == 'operator' %} disabled title="Access Denied" {% endif %}
          ><i class='bx bx-edit'></i></button>

          <button class="table-action-btn delete-btn"
            {% if not user_logged_in or role == 'operator' %} disabled title="Access Denied" {% endif %}
          ><i class='bx bx-trash'></i></button>
        </td>
      `;

      tableBody.appendChild(tr);
    });
  }

  /* =========================================================
       ADD NEW ROW (OPERATOR FIELD DISABLED)
  ========================================================= */
  addRowBtn.addEventListener("click", () => {

    if (document.querySelector(".new-row")) return;

    const tr = document.createElement("tr");
    tr.classList.add("new-row");

    tr.innerHTML = `
      <td><input type="text" class="edit-input" placeholder="Silo No"></td>
      <td><input type="text" class="edit-input" placeholder="Material Name"></td>
      <td><input type="text" class="edit-input" placeholder="Material Code"></td>

      <!-- AUTO OPERATOR NAME (DISABLED) -->
      <td><input type="text" class="edit-input" value="{{ role }}" disabled></td>

      <td><input type="text" class="edit-input" value="0" disabled></td>

      <td>
        <button class="table-action-btn save-new-btn"><i class='bx bx-check'></i></button>
        <button class="table-action-btn cancel-new-btn"><i class='bx bx-x'></i></button>
      </td>
    `;

    tableBody.prepend(tr);

    tr.querySelector(".cancel-new-btn").onclick = () => tr.remove();

    tr.querySelector(".save-new-btn").onclick = async () => {

      const inputs = tr.querySelectorAll("input");

      const newData = {
        SiloNo: inputs[0].value.trim(),
        MaterialName: inputs[1].value.trim(),
        MaterialCode: inputs[2].value.trim()
      };

      if (!newData.SiloNo || !newData.MaterialName) {
        alert("Fill required fields!");
        return;
      }

      const res = await fetch("/api/stocks/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(newData)
      });

      const result = await res.json();
      if (result.success) loadStocks();
      else alert(result.error);
    };
  });

  /* =========================================================
       EDIT / DELETE (OPERATOR DISABLED)
  ========================================================= */
  tableBody.addEventListener("click", async (e) => {

    // EDIT
    const editBtn = e.target.closest(".edit-btn");
    if (editBtn) {

      const row = editBtn.closest("tr");
      if (row.classList.contains("editing")) return;

      row.classList.add("editing");

      const cols = row.querySelectorAll("td");
      const siloNo = row.dataset.silono;

      for (let i = 0; i < 5; i++) {
        const val = cols[i].innerText.trim();

        if (i === 3 || i === 4) {
          cols[i].innerHTML = `<input class="edit-input" value="${val}" disabled>`;
        } else {
          cols[i].innerHTML = `<input class="edit-input" value="${val}">`;
        }
      }

      cols[5].innerHTML = `
        <button class="table-action-btn save-btn"><i class='bx bx-check'></i></button>
        <button class="table-action-btn cancel-btn"><i class='bx bx-x'></i></button>
      `;

      cols[5].querySelector(".cancel-btn").onclick = () => loadStocks();

      cols[5].querySelector(".save-btn").onclick = async () => {
        const inputs = row.querySelectorAll("input");

        const updated = {
          SiloNo: inputs[0].value.trim(),
          MaterialName: inputs[1].value.trim(),
          MaterialCode: inputs[2].value.trim()
        };

        const res = await fetch(`/api/stocks/update/${siloNo}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updated)
        });

        const result = await res.json();
        if (result.success) loadStocks();
        else alert(result.error);
      };
    }

    // DELETE
    const deleteBtn = e.target.closest(".delete-btn");
    if (deleteBtn) {
      const row = deleteBtn.closest("tr");
      const siloNo = row.dataset.silono;

      if (!confirm(`Delete Silo ${siloNo}?`)) return;

      const res = await fetch(`/api/stocks/delete/${siloNo}`, { method: "DELETE" });

      const result = await res.json();
      if (result.success) row.remove();
    }

  });

  /* =========================================================
       SEARCH FILTER
  ========================================================= */
  searchBox.addEventListener("input", () => {
    const filter = searchBox.value.toLowerCase();
    Array.from(tableBody.querySelectorAll("tr")).forEach(row => {
      row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
    });
  });

  /* =========================================================
       EXPORT EXCEL (FIXED ENDPOINT)
  ========================================================= */
  exportBtn.addEventListener("click", async () => {
    const res = await fetch("/api/stocks/export", { method: "POST" });
    const blob = await res.blob();

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "MaterialData.xlsx";
    a.click();
  });

  loadStocks();
});
</script>

{% endblock %}
