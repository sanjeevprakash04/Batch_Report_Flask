{% extends 'base.html' %}

{% block content %}
<div class="inv-navbar">
  <div class="inv-navbar-left">
    <span class="inv-app-title">Stocks</span>
  </div>

  <div class="inv-navbar-right">
    <button class="add-btn" id="addRowBtn">Add</button>
    <button class="add-btn" id="exportBtn">Export</button>
    <input class="search-input" type="text" id="searchBox" placeholder="Search...">
  </div>
</div>

<!-- Table -->
<div class="stocks-table-wrapper">
  <table class="stocks-table">
    <thead>
      <tr>
        <th class="sortable" data-col="0">Silo No</th>
        <th class="sortable" data-col="1">Raw Material Name</th>
        <th class="sortable" data-col="2">Raw Material Code</th>
        <th class="sortable" data-col="3">Operator Name</th>
        <th class="sortable" data-col="4">TotalExtracted(kg)</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="stocksTableBody">
      <tr>
        <td colspan="5" class="table-error">Loading data...</td>
      </tr>
    </tbody>
  </table>
</div>

<!-- JS -->
<script>
document.addEventListener("DOMContentLoaded", async () => {

  const tableBody = document.getElementById("stocksTableBody");
  const searchBox = document.getElementById("searchBox");
  const addRowBtn = document.getElementById("addRowBtn");
  const exportBtn = document.getElementById("exportBtn");

  // ---------------------------------------
  // ✅ SORTING LOGIC ADDED HERE
  // ---------------------------------------
  let sortState = {};  // Track ASC/DESC

  function sortTable(colIndex, isNumeric = false) {
    let rows = Array.from(tableBody.querySelectorAll("tr"));

    // Toggle asc/desc
    sortState[colIndex] = sortState[colIndex] === "asc" ? "desc" : "asc";

    rows.sort((a, b) => {
      let aVal = a.children[colIndex]?.innerText.trim() || "";
      let bVal = b.children[colIndex]?.innerText.trim() || "";

      if (isNumeric) {
        aVal = parseFloat(aVal) || 0;
        bVal = parseFloat(bVal) || 0;
      }

      if (sortState[colIndex] === "asc") {
        return aVal > bVal ? 1 : -1;
      }
      return aVal < bVal ? 1 : -1;
    });

    tableBody.innerHTML = "";
    rows.forEach(r => tableBody.appendChild(r));
  }

  document.querySelectorAll("th.sortable").forEach((th) => {
    const index = Number(th.dataset.col);
    th.style.cursor = "pointer";

    th.addEventListener("click", () => {
      const numericCols = [4]; // TotalExtracted column
      sortTable(index, numericCols.includes(index));
    });
  });

  // ---------------------------------------
  // END SORTING LOGIC
  // ---------------------------------------


  // ✅ Load all stock records
  async function loadStocks() {
    try {
      const response = await fetch("/api/stocks");
      const data = await response.json();
      tableBody.innerHTML = "";

      if (!data.success || !data.records.length) {
        tableBody.innerHTML = `<tr><td colspan="5" class="table-error">No records found</td></tr>`;
        return;
      }

      data.records.forEach((row) => {
        const tr = document.createElement("tr");
        tr.dataset.silono = row.SiloNo;

        tr.innerHTML = `
          <td>${row.SiloNo || "-"}</td>
          <td>${row.MaterialName || "-"}</td>
          <td>${row.MaterialCode || "-"}</td>
          <td>${row.OperatorName || "-"}</td>
          <td>${row.TotalExtracted || "0"}</td>
          <td class="action-cell">
            <button class="table-action-btn edit-btn" title="Edit"><i class='bx bx-edit'></i></button>
            <button class="table-action-btn delete-btn" title="Delete"><i class='bx bx-trash'></i></button>
          </td>
        `;
        tableBody.appendChild(tr);
      });
    } catch (err) {
      console.error("❌ Failed to load:", err);
      tableBody.innerHTML = `<tr><td colspan="5" class="table-error">Failed to load data</td></tr>`;
    }
  }

  // (ALL YOUR EXISTING CODE BELOW — unchanged)
  // -------------------------------------------------------
  // ADD, EDIT, DELETE, SEARCH, EXPORT — unchanged
  // -------------------------------------------------------

  // … [same code as your original after sorting block]

  loadStocks();
});
</script>
{% endblock %}
