{% extends 'analytics.html' %}
{% block analytics_dataview %}

<!-- ===============================
      ANALYTICS HEADER
=============================== -->
<div style="width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem;">
  <div class="inv-navbar-right">
    <select id="hourSelect" class="inv-select">
      <option value="1 Hr">1 Hr</option>
      <option value="4 Hr">4 Hr</option>
      <option value="8 Hr">8 Hr</option>
      <option value="12 Hr">12 Hr</option>
      <option value="24 Hr">24 Hr</option>
      <option value="Custom">Custom</option>
    </select>

    <div class="date-filter">
      <span>From:</span>
      <input type="datetime-local" id="fromDate" class="inv-input">
    </div>
    <div class="date-filter">
      <span>To:</span>
      <input type="datetime-local" id="toDate" class="inv-input">
    </div>

    <button id="viewBtn" class="inv-button">View</button>
    <button id="exportBtn" class="inv-button">Export</button>
    <button id="analyticsBtn" class="inv-button">Analytics</button>
    <span id="totalLabel" class="total-label">Total Batch Weight (in Tons): --</span>
  </div>
</div>

<!-- ===============================
      ANALYTICS TABLE
=============================== -->
<div class="table-wrapper-analytics">
  <table class="inv-table" id="reportTable">
    <thead>
      <tr><th>Waiting...</th></tr>
    </thead>
    <tbody>
      <tr><td>Waiting for data...</td></tr>
    </tbody>
  </table>
</div>

<!-- ===============================
      POPUP MODAL
=============================== -->
<div id="popupModal" class="popup-overlay" style="display: none;">
  <div class="popup-content">
    <h3 id="popupTitle" style="margin-left: 0.3rem;">PLC Data</h3>
    <div class="popup-table-wrapper">
      <table class="inv-table" id="popupTable">
        <thead><tr><th>Loading...</th></tr></thead>
        <tbody><tr><td>Loading data...</td></tr></tbody>
      </table>
    </div>

    <div class="popup-footer">
      <button id="downloadPopupExcel" class="inv-button success">Download Excel</button>
      <button id="closePopup" class="inv-button warning">Close</button>
    </div>
  </div>
</div>

<!-- ===============================
      SCRIPT
=============================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  const hourSelect = document.getElementById("hourSelect");
  const fromDate = document.getElementById("fromDate");
  const toDate = document.getElementById("toDate");
  const viewBtn = document.getElementById("viewBtn");
  const exportBtn = document.getElementById("exportBtn");
  const analyticsBtn = document.getElementById("analyticsBtn");
  const totalLabel = document.getElementById("totalLabel");

  const tableHead = document.querySelector("#reportTable thead");
  const tableBody = document.querySelector("#reportTable tbody");

  const popup = document.getElementById("popupModal");
  const popupTitle = document.getElementById("popupTitle");
  const popupTableHead = document.querySelector("#popupTable thead");
  const popupTableBody = document.querySelector("#popupTable tbody");
  const closePopup = document.getElementById("closePopup");

  /* ======================================================
      âœ” DISABLE FUTURE DATES + AUTO SELECT CUSTOM
  ====================================================== */
  const now = new Date().toISOString().slice(0, 16);
  fromDate.max = now;
  toDate.max = now;

  fromDate.addEventListener("click", () => hourSelect.value = "Custom");
  toDate.addEventListener("click", () => hourSelect.value = "Custom");

  hourSelect.addEventListener("change", () => {
    if (hourSelect.value !== "Custom") {
      fromDate.value = "";
      toDate.value = "";
    }
  });

  /* ======================================================
      âœ” RESTORE SESSION STORAGE
  ====================================================== */
  function restoreSession() {
    const filters = JSON.parse(sessionStorage.getItem("analytics_filters"));
    const tableData = JSON.parse(sessionStorage.getItem("analytics_table"));
    const savedTotal = sessionStorage.getItem("analytics_total");

    if (filters) {
      hourSelect.value = filters.hours;
      fromDate.value = filters.from_time;
      toDate.value = filters.to_time;
    }

    if (tableData) {
      renderTable(tableData);
      totalLabel.textContent = "Total Batch Weight (in Tons): " + savedTotal;
    }
  }
  restoreSession();

  /* ======================================================
      VIEW BUTTON
  ====================================================== */
  viewBtn.addEventListener("click", async () => {
    const hours = hourSelect.value;
    const from_time = fromDate.value;
    const to_time = toDate.value;

    if (hours === "Custom" && (!from_time || !to_time)) {
      alert("Please select both From and To for Custom range!");
      return;
    }

    tableHead.innerHTML = `<tr><th>Loading...</th></tr>`;
    tableBody.innerHTML = `<tr><td>Loading...</td></tr>`;

    const res = await fetch("/api/analytics_data", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ hours, from_time, to_time })
    });

    const result = await res.json();
    if (!result.success) return;

    renderTable(result.data);
    totalLabel.textContent = `Total Batch Weight (in Tons): ${result.total_weight}`;

    // SAVE SESSION
    sessionStorage.setItem("analytics_filters", JSON.stringify({ hours, from_time, to_time }));
    sessionStorage.setItem("analytics_table", JSON.stringify(result.data));
    sessionStorage.setItem("analytics_total", result.total_weight);
  });

  /* ======================================================
      EXPORT BUTTON
  ====================================================== */
  exportBtn.addEventListener("click", async () => {
    const hours = hourSelect.value;
    const from_time = fromDate.value;
    const to_time = toDate.value;

    const res = await fetch("/api/export_data_analytics", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ hours, from_time, to_time })
    });

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `Analytics_${hours.replace(" ", "_")}.xlsx`;
    a.click();

    URL.revokeObjectURL(url);
  });

  /* ======================================================
      ANALYTICS DASH
  ====================================================== */
  analyticsBtn.addEventListener("click", async () => {
    try {
      const res = await fetch("/api/analytics/dash");
      const result = await res.json();

      if (result.success) {
        window.open(result.url, "_blank");
      } else {
        alert("Failed to open analytics dashboard.");
      }
    } catch (err) {
      alert("Error launching dashboard.");
    }
  });

  /* ======================================================
      RENDER MAIN TABLE
  ====================================================== */
  function renderTable(data) {

    const cols = [
      { key: "Category", label: "Category" },
      { key: "SetWeight", label: "Set Weight (Kg)" },
      { key: "ActualWeight", label: "Actual Weight (Kg)" },
      { key: "Error_Kg", label: "Error (Kg)" },
      { key: "Error_%", label: "Error (%)" }
    ];

    // ðŸ”¹ Table Header
    tableHead.innerHTML = `
      <tr>${cols.map(c => `<th>${c.label}</th>`).join("")}</tr>
    `;

    // ðŸ”¹ Table Body
    tableBody.innerHTML = "";

    data.forEach(row => {
      const tr = document.createElement("tr");

      // Each cell uses c.key (correct!)
      tr.innerHTML = cols
        .map(c => `<td>${row[c.key] ?? ""}</td>`)
        .join("");

      tr.style.cursor = "pointer";

      tr.addEventListener("click", () => openPopup(row["Category"]));

      tableBody.appendChild(tr);
    });

  }

  /* ======================================================
      POPUP WINDOW
  ====================================================== */
  async function openPopup(category) {
    popup.style.display = "flex";
    popupTitle.textContent = `PLC Data for: ${category}`;

    popupTableHead.innerHTML = `<tr><th>Loading...</th></tr>`;
    popupTableBody.innerHTML = `<tr><td>Loading...</td></tr>`;

    const hours = hourSelect.value;
    const from_time = fromDate.value;
    const to_time = toDate.value;

    const res = await fetch("/api/plc_data_analytics", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ category, hours, from_time, to_time })
    });

    const result = await res.json();

    const data = result.data;
    if (!data || data.length === 0) {
      popupTableHead.innerHTML = `<tr><th>No Data</th></tr>`;
      popupTableBody.innerHTML = `<tr><td>No PLC Data Available</td></tr>`;
      return;
    }

    const allCols = [
      { key: "Category", label: "Category" },
      { key: "SetWeight", label: "Set Weight (Kg)" },
      { key: "ActualWeight", label: "Actual Weight (Kg)" },
      { key: "FineWeight", label: "Fine Weight (Kg)" },
      { key: "Error_Kg", label: "Error (Kg)" },
      { key: "Error_%", label: "Error (%)" },
      { key: "DiffPerc", label: "Difference (%)" },
      { key: "DiffKg", label: "Difference (Kg)" },
      { key: "TimeStamp", label: "Timestamp" }
    ];

    // Only keep columns that exist in the data
    const cols = allCols.filter(col => col.key in data[0]);

    // ---- Header ----
    popupTableHead.innerHTML =
      `<tr>${cols.map(col => `<th>${col.label}</th>`).join("")}</tr>`;

    // ---- Body ----
    popupTableBody.innerHTML =
      data.map(row =>
        `<tr>${cols.map(col => `<td>${row[col.key] ?? ""}</td>`).join("")}</tr>`
      ).join("");

  }
  document.getElementById("downloadPopupExcel").addEventListener("click", async () => {

    const category = popupTitle.textContent.replace("PLC Data for: ", "");

    const hours = hourSelect.value;
    const from_time = fromDate.value;
    const to_time = toDate.value;

    const res = await fetch("/api/plc_data_analytics_excel", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ category, hours, from_time, to_time })
    });

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `PLC_Data_${category}.xlsx`;
    a.click();

    URL.revokeObjectURL(url);
  });

  closePopup.addEventListener("click", () => popup.style.display = "none");



});
</script>

{% endblock %}
