{% extends 'analytics.html' %}
{% block analytics_dataview %}

<!-- ===============================
      ANALYTICS HEADER
=============================== -->
<div style="width:100%;display:flex;justify-content:space-between;align-items:center;padding:0.5rem 1rem;">
  <div class="inv-navbar-right">

    <select id="hourSelect" class="inv-select">
      <option value="1 Hr">1 Hr</option>
      <option value="4 Hr">4 Hr</option>
      <option value="8 Hr">8 Hr</option>
      <option value="12 Hr">12 Hr</option>
      <option value="24 Hr">24 Hr</option>
      <option value="Custom">Custom</option>
    </select>

    <div class="date-filter">
      <span>From:</span>
      <input type="datetime-local" id="fromDate" class="inv-input">
    </div>

    <div class="date-filter">
      <span>To:</span>
      <input type="datetime-local" id="toDate" class="inv-input">
    </div>

    <button id="viewBtn" class="inv-button">View</button>
    <button id="exportBtn" class="inv-button">Export</button>
    <button id="analyticsBtn" class="inv-button">Analytics</button>

    <span id="totalLabel" class="total-label">
      Total Batch Weight (in Tons): --
    </span>
  </div>
</div>

<!-- ===============================
      TABLE
=============================== -->
<div class="table-wrapper-analytics">
  <table class="inv-table" id="reportTable">
    <thead><tr><th>Waiting...</th></tr></thead>
    <tbody><tr><td>Waiting for data...</td></tr></tbody>
  </table>
</div>

<!-- ===============================
      POPUP
=============================== -->
<div id="popupModal" class="popup-overlay" style="display:none;">
  <div class="popup-content">
    <h3 id="popupTitle">PLC Data</h3>

    <div class="popup-table-wrapper">
      <table class="inv-table" id="popupTable">
        <thead><tr><th>Loading...</th></tr></thead>
        <tbody><tr><td>Loading...</td></tr></tbody>
      </table>
    </div>

    <div class="popup-footer">
      <button id="closePopup" class="inv-button warning">Close</button>
    </div>
  </div>
</div>

<!-- ===============================
      SCRIPT
=============================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  const hourSelect = document.getElementById("hourSelect");
  const fromDate   = document.getElementById("fromDate");
  const toDate     = document.getElementById("toDate");
  const viewBtn    = document.getElementById("viewBtn");
  const exportBtn  = document.getElementById("exportBtn");
  const analyticsBtn = document.getElementById("analyticsBtn");
  const totalLabel = document.getElementById("totalLabel");

  const tableHead = document.querySelector("#reportTable thead");
  const tableBody = document.querySelector("#reportTable tbody");

  const popup = document.getElementById("popupModal");
  const popupTitle = document.getElementById("popupTitle");
  const popupTableHead = document.querySelector("#popupTable thead");
  const popupTableBody = document.querySelector("#popupTable tbody");
  const closePopup = document.getElementById("closePopup");

  let isRestoring = true;
  let sortState = {};
  let currentData = [];

  /* ----------------------------------------------------
     Disable future dates
  ---------------------------------------------------- */
  const now = new Date().toISOString().slice(0,16);
  fromDate.max = now;
  toDate.max   = now;

  /* ----------------------------------------------------
     Restore Session (UPDATED)
  ---------------------------------------------------- */
  async function restoreSession() {
    const filters = JSON.parse(localStorage.getItem("analytics_filters"));
    const table   = JSON.parse(localStorage.getItem("analytics_table"));
    const total   = localStorage.getItem("analytics_total");

    /* ========= CASE 1: EXISTING SESSION ========= */
    if (filters && table && table.length) {
      hourSelect.value = filters.hours;
      fromDate.value = filters.from_time || "";
      toDate.value   = filters.to_time || "";

      currentData = table;
      renderTable(table);
      totalLabel.textContent = `Total Batch Weight (in Tons): ${total}`;

      isRestoring = false;
      return;
    }

    /* ========= CASE 2: FIRST LOAD â†’ DEFAULT CUSTOM ========= */
    const defaultFrom = "2025-05-01T00:00";
    const defaultTo   = "2025-06-30T23:59";

    hourSelect.value = "Custom";
    fromDate.value = defaultFrom;
    toDate.value   = defaultTo;

    tableHead.innerHTML = "<tr><th>Loading...</th></tr>";
    tableBody.innerHTML = "<tr><td>Loading...</td></tr>";

    const res = await fetch("/api/analytics_data", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        hours: "Custom",
        from_time: defaultFrom,
        to_time: defaultTo
      })
    });

    const r = await res.json();
    if (!r.success) return;

    currentData = r.data;
    renderTable(r.data);
    totalLabel.textContent = `Total Batch Weight (in Tons): ${r.total_weight}`;

    localStorage.setItem("analytics_filters", JSON.stringify({
      hours:"Custom",
      from_time: defaultFrom,
      to_time: defaultTo
    }));
    localStorage.setItem("analytics_table", JSON.stringify(r.data));
    localStorage.setItem("analytics_total", r.total_weight);

    isRestoring = false;
  }
  restoreSession();

  /* ----------------------------------------------------
     User interaction
  ---------------------------------------------------- */
  fromDate.addEventListener("click", () => !isRestoring && (hourSelect.value="Custom"));
  toDate.addEventListener("click", () => !isRestoring && (hourSelect.value="Custom"));

  hourSelect.addEventListener("change", () => {
    if (isRestoring) return;
    if (hourSelect.value !== "Custom") {
      fromDate.value = "";
      toDate.value = "";
    }
  });

  /* ----------------------------------------------------
     Render Table + Sorting
  ---------------------------------------------------- */
  function renderTable(data) {
    const cols = [
      {k:"Category",l:"Category"},
      {k:"SetWeight",l:"Set Weight"},
      {k:"ActualWeight",l:"Actual Weight"},
      {k:"Error_Kg",l:"Error (Kg)"},
      {k:"Error_%",l:"Error (%)"}
    ];

    tableHead.innerHTML =
      `<tr>${cols.map((c,i)=>`<th data-i="${i}" style="cursor:pointer">${c.l}</th>`).join("")}</tr>`;

    tableBody.innerHTML = "";
    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = cols.map(c => `<td>${row[c.k] ?? ""}</td>`).join("");
      tr.onclick = () => openPopup(row.Category);
      tableBody.appendChild(tr);
    });

    enableSorting(cols, data);
  }

  function enableSorting(cols, data) {
    tableHead.querySelectorAll("th").forEach(th => {
      th.onclick = () => {
        const i = th.dataset.i;
        sortState[i] = sortState[i] === "asc" ? "desc" : "asc";

        data.sort((a,b)=>{
          let A = a[cols[i].k];
          let B = b[cols[i].k];
          if (!isNaN(A) && !isNaN(B)) {
            return sortState[i] === "asc" ? A-B : B-A;
          }
          return sortState[i] === "asc"
            ? String(A).localeCompare(String(B))
            : String(B).localeCompare(String(A));
        });

        renderTable(data);
      };
    });
  }

  /* ----------------------------------------------------
     View Button (UNCHANGED)
  ---------------------------------------------------- */
  viewBtn.onclick = async () => {
    const hours = hourSelect.value;
    const from_time = fromDate.value;
    const to_time   = toDate.value;

    if (hours==="Custom" && (!from_time || !to_time)) {
      alert("Select From & To");
      return;
    }

    tableHead.innerHTML = "<tr><th>Loading...</th></tr>";
    tableBody.innerHTML = "<tr><td>Loading...</td></tr>";

    const res = await fetch("/api/analytics_data", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({hours,from_time,to_time})
    });

    const r = await res.json();
    if (!r.success) return;

    currentData = r.data;
    renderTable(r.data);
    totalLabel.textContent = `Total Batch Weight (in Tons): ${r.total_weight}`;

    localStorage.setItem("analytics_filters",JSON.stringify({hours,from_time,to_time}));
    localStorage.setItem("analytics_table",JSON.stringify(r.data));
    localStorage.setItem("analytics_total",r.total_weight);
  };

  /* ----------------------------------------------------
     Export (UNCHANGED)
  ---------------------------------------------------- */
  exportBtn.onclick = async () => {
    const from_time = fromDate.value;
    const to_time = toDate.value;

    const safeFrom = from_time ? from_time.replace(/[:T]/g,"-") : "AUTO";
    const safeTo   = to_time ? to_time.replace(/[:T]/g,"-") : "NOW";

    const res = await fetch("/api/export_data_analytics",{method:"POST"});
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `SKEW_Analytics_${safeFrom}_to_${safeTo}.xlsx`;
    a.click();
    URL.revokeObjectURL(url);
  };

  /* ----------------------------------------------------
     Popup
  ---------------------------------------------------- */
  function openPopup(category) {
    popup.style.display="flex";
    popupTitle.textContent = `PLC Data for: ${category}`;
  }

  closePopup.onclick = () => popup.style.display="none";

});
</script>

{% endblock %}
