{% extends 'base.html' %}
{% block content %}

<!-- =============================== REPORT HEADER =============================== -->
<div class="inv-navbar">
  <div class="inv-navbar-left">
    <span class="inv-app-title">Report</span>
  </div>

  <div class="inv-navbar-right">
    <select id="hourSelect" class="inv-select">
      <option value="1 Hr">1 Hr</option>
      <option value="4 Hr">4 Hr</option>
      <option value="8 Hr">8 Hr</option>
      <option value="12 Hr">12 Hr</option>
      <option value="24 Hr">24 Hr</option>
      <option value="Custom">Custom</option>
    </select>

    <div class="date-filter">
      <span>From:</span>
      <input type="datetime-local" id="fromDate" class="inv-input">
    </div>

    <div class="date-filter">
      <span>To:</span>
      <input type="datetime-local" id="toDate" class="inv-input">
    </div>

    <button id="viewBtn" class="inv-button">View</button>
    <button id="exportBtn" class="inv-button">Export</button>

    <span id="totalLabel" class="total-label">Total Batch Weight (in Tons): --</span>
  </div>
</div>

<!-- =============================== REPORT TABLE =============================== -->
<div class="report-table-wrapper">
  <table class="inv-table" id="reportTable">
    <thead><tr><th>Waiting...</th></tr></thead>
    <tbody><tr><td>Waiting for data...</td></tr></tbody>
  </table>
</div>

<!-- =============================== POPUP MODAL =============================== -->
<div id="popupModal" class="popup-overlay" style="display:none;">
  <div class="popup-content">
    <h3 id="popupTitle" style="margin-left: 0.3rem;">PLC Data</h3>

    <div class="popup-table-wrapper">
      <table class="inv-table" id="popupTable">
        <thead><tr><th>Loading...</th></tr></thead>
        <tbody><tr><td>Loading...</td></tr></tbody>
      </table>
    </div>

    <div class="popup-footer">
      <button id="downloadPDF" class="inv-button primary">Download PDF</button>
      <button id="downloadExcel" class="inv-button success">Download Excel</button>
      <button id="closePopup" class="inv-button warning">Close</button>
    </div>
  </div>
</div>

<!-- =============================== SCRIPT =============================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  const hourSelect = document.getElementById("hourSelect");
  const fromDate = document.getElementById("fromDate");
  const toDate = document.getElementById("toDate");
  const viewBtn = document.getElementById("viewBtn");
  const exportBtn = document.getElementById("exportBtn");

  const table = document.getElementById("reportTable");
  const tableHead = table.querySelector("thead");
  const tableBody = table.querySelector("tbody");

  const popup = document.getElementById("popupModal");
  const popupTitle = document.getElementById("popupTitle");
  const popupTableHead = document.querySelector("#popupTable thead");
  const popupTableBody = document.querySelector("#popupTable tbody");

  const totalLabel = document.getElementById("totalLabel");



/* ------------------------------ Disable Future Dates ------------------------------ */
const now = new Date().toISOString().slice(0, 16);
fromDate.max = now;
toDate.max = now;

fromDate.addEventListener("click", () => hourSelect.value = "Custom");
toDate.addEventListener("click", () => hourSelect.value = "Custom");

hourSelect.addEventListener("change", () => {
  if (hourSelect.value !== "Custom") {
    fromDate.value = "";
    toDate.value = "";
  }
});



/* =====================================================
   UNIVERSAL SORTING LOGIC (ASC + DESC)
===================================================== */
let sortState = {};

function enableSorting(head, body) {
    const headers = head.querySelectorAll("th");

    headers.forEach((th, index) => {
        th.style.cursor = "pointer";
        th.addEventListener("click", () => sortTable(body, index));
    });
}

function sortTable(body, colIndex) {

    let rows = Array.from(body.querySelectorAll("tr"));
    sortState[colIndex] = sortState[colIndex] === "asc" ? "desc" : "asc";

    rows.sort((a, b) => {
        let aVal = a.children[colIndex]?.innerText.trim() || "";
        let bVal = b.children[colIndex]?.innerText.trim() || "";

        // Auto numeric detection
        const isNumeric = !isNaN(parseFloat(aVal)) && !isNaN(parseFloat(bVal));

        if (isNumeric) {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
        }

        if (sortState[colIndex] === "asc") {
            return aVal > bVal ? 1 : -1;
        }
        return aVal < bVal ? 1 : -1;
    });

    // Update table
    body.innerHTML = "";
    rows.forEach(r => body.appendChild(r));
}



/* ------------------------------ Render Main Table ------------------------------ */
function renderTable(data) {

  const columns = Object.keys(data[0]);

  tableHead.innerHTML = `
    <tr>${columns.map(c => `<th>${c}</th>`).join("")}</tr>
  `;

  tableBody.innerHTML = data
    .map(row => `
      <tr onclick="openPopup('${row["BatchNo"]}')">
        ${columns.map(c => `<td>${row[c]}</td>`).join("")}
      </tr>
    `)
    .join("");

  // Enable sorting for ALL columns
  setTimeout(() => enableSorting(tableHead, tableBody), 10);
}



/* ------------------------------ Restore Session ------------------------------ */
function restoreSession() {
  let savedFilters = JSON.parse(localStorage.getItem("report_filters"));
  let savedTable = JSON.parse(localStorage.getItem("report_table"));
  let savedTotal = localStorage.getItem("report_total");

  if (savedFilters) {
    hourSelect.value = savedFilters.hours;
    fromDate.value = savedFilters.from_time;
    toDate.value = savedFilters.to_time;
  }

  if (savedTable) {
    renderTable(savedTable);
    totalLabel.textContent = `Total Batch Weight (in Tons): ${savedTotal}`;
  }
}
restoreSession();



/* ------------------------------ View Button Handler ------------------------------ */
viewBtn.addEventListener("click", async () => {

  const hours = hourSelect.value;
  const from_time = fromDate.value;
  const to_time = toDate.value;

  tableHead.innerHTML = "<tr><th>Loading...</th></tr>";
  tableBody.innerHTML = "<tr><td>Loading...</td></tr>";

  const res = await fetch("/api/report_data", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ hours, from_time, to_time })
  });

  const result = await res.json();
  if (!result.success) return;

  renderTable(result.data);
  totalLabel.textContent = `Total Batch Weight (in Tons): ${result.total_weight}`;

  localStorage.setItem("report_filters", JSON.stringify({ hours, from_time, to_time }));
  localStorage.setItem("report_table", JSON.stringify(result.data));
  localStorage.setItem("report_total", result.total_weight);
});



/* ------------------------------ Export Excel ------------------------------ */
exportBtn.addEventListener("click", async () => {

  const hours = hourSelect.value;
  const from_time = fromDate.value;
  const to_time = toDate.value;

  const res = await fetch("/api/export_data", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ hours, from_time, to_time })
  });

  const blob = await res.blob();
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "Report.xlsx";
  a.click();

  URL.revokeObjectURL(url);
});



/* ------------------------------ POPUP VIEW ------------------------------ */
window.openPopup = async function(batchNo) {

  popup.style.display = "flex";
  popupTitle.textContent = `PLC Data for BatchNo: ${batchNo}`;

  popupTableHead.innerHTML = "<tr><th>Loading...</th></tr>";
  popupTableBody.innerHTML = "<tr><td>Loading...</td></tr>";

  const res = await fetch("/api/plc_data", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ batch_no: batchNo })
  });

  const result = await res.json();
  const data = result.data;

  if (!data || data.length === 0) {
    popupTableHead.innerHTML = "<tr><th>No Data</th></tr>";
    popupTableBody.innerHTML = "<tr><td>No PLC data found</td></tr>";
    return;
  }

  const cols = [
    { key: "SiloNo", label: "Silo No" },
    { key: "Category", label: "Category" },
    { key: "MaterialName", label: "Material Name" },
    { key: "SetWeight", label: "Set Weight (Kg)" },
    { key: "ActualWeight", label: "Actual Weight (Kg)" },
    { key: "Difference", label: "Difference (Kg)" },
    { key: "Tolerance", label: "Tolerance (Kg)" }
  ];

  popupTableHead.innerHTML = `
    <tr>${cols.map(c => `<th>${c.label}</th>`).join("")}</tr>
  `;

  popupTableBody.innerHTML = data
    .map(row => `
      <tr>
        ${cols.map(c => `<td>${row[c.key] ?? ""}</td>`).join("")}
      </tr>
    `)
    .join("");

  // Enable sorting for popup table
  setTimeout(() => enableSorting(popupTableHead, popupTableBody), 10);


  document.getElementById("downloadPDF").onclick = () => downloadReport("pdf", batchNo);
  document.getElementById("downloadExcel").onclick = () => downloadReport("excel", batchNo);
};

document.getElementById("closePopup").onclick = () => popup.style.display = "none";



/* ------------------------------ Download Report ------------------------------ */
async function downloadReport(type, batchNo) {

  const endpoint = type === "pdf" ? "/api/plc_data/pdf" : "/api/plc_data/excel";
  const filename = `BatchReport_${batchNo}.${type === "pdf" ? "pdf" : "xlsx"}`;

  const res = await fetch(endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ batch_no: batchNo })
  });

  const blob = await res.blob();
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();

  URL.revokeObjectURL(url);
}

});
</script>

{% endblock %}
