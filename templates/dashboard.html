{% extends 'base.html' %}
{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">

<!-- Google Charts -->
<script src="https://www.gstatic.com/charts/loader.js"></script>

<!-- Screenshot + PDF Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<div class="inv-navbar">
    <div class="inv-navbar-left">
        <span class="inv-app-title">Dashboard</span>
    </div>

    <div class="inv-navbar-right">

        <select id="hourSelect" class="inv-select">
            <option value="1 Hr">1 Hr</option>
            <option value="4 Hr">4 Hr</option>
            <option value="8 Hr">8 Hr</option>
            <option value="12 Hr">12 Hr</option>
            <option value="24 Hr">24 Hr</option>
            <option value="Custom">Custom</option>
        </select>

        <div class="date-filter">
            <span>From:</span>
            <input type="datetime-local" id="fromDate" class="inv-input" style="font-family: Arial, sans-serif;">
        </div>

        <div class="date-filter">
            <span>To:</span>
            <input type="datetime-local" id="toDate" class="inv-input" style="font-family: Arial, sans-serif;">
        </div>

        <!-- Download Button -->
        <button id="dwnBtn" class="inv-button">Print</button>

    </div>
</div>


<!-- WRAPPER FOR PDF SCREENSHOT -->
<div id="dashboardContainer" class="dashboard-content">

    <!-- GRID -->
    <div class="dashboard-grid">

        <!-- Summary Cards -->
        <div class="grid-item">
            <div class="summary-cards">
                <div class="card">
                    <h3>Production</h3>
                    <p class="value" id="prod_today">0</p>
                    <span class="unit">tons</span>
                </div>

                <div class="card">
                    <h3>No. of Batches</h3>
                    <p class="value" id="batch_count">0</p>
                </div>

                <div class="card">
                    <h3>Tons per Hour</h3>
                    <p class="value" id="tph">0</p>
                    <span class="unit">TPH</span>
                </div>

                <div class="card">
                    <h3>Batch Accuracy</h3>
                    <p class="value" id="batch_acc">0%</p>
                </div>

                <div class="card">
                    <h3>Avg Batch Cycle Time</h3>
                    <p class="value" id="cycle_time">0</p>
                    <span class="unit">min</span>
                </div>
            </div>
        </div>

        <!-- Donut Chart -->
        <div class="grid-item">
            <div class="chart-box-recipe">
                <h3 class="chart-title">Production by Recipe</h3>
                <div id="recipeChart"></div>
            </div>
        </div>

        

        <!-- Line Chart -->
        <div class="grid-item">
            <div class="chart-box">
                <h3 class="chart-title">Production Line</h3>
                <div id="lineChart"></div>
            </div>
        </div>

        <!-- Bar Chart -->
        <div class="grid-item">
            <div class="chart-box">
                <h3 class="chart-title">Raw Material Consumption</h3>
                <div id="siloChart"></div>
            </div>
        </div>

        <!-- Calendar Chart -->
        <div class="grid-item">
            <div class="chart-box">
                <h3 class="chart-title">Production Calendar</h3>
                <div id="calendarChart" style="height: 350px;"></div>
            </div>
        </div>

    </div>

</div> <!-- END dashboardContainer -->


<script>
google.charts.load('current', {packages: ['corechart', 'calendar']});

/* =========================
       SAVE / LOAD FILTERS
========================= */
function saveFilters(from, to, hours) {
    localStorage.setItem("dash_from", from);
    localStorage.setItem("dash_to", to);
    localStorage.setItem("dash_hours", hours);
}

function loadFilters() {
    let from = localStorage.getItem("dash_from");
    let to = localStorage.getItem("dash_to");
    let hours = localStorage.getItem("dash_hours");

    if (!from || !to) {
        from = "2025-03-01T00:00";
        to = "2025-04-30T23:59";
        saveFilters(from, to, "Custom");
    }

    fromDate.value = from;
    toDate.value = to;
    hourSelect.value = hours || "Custom";
    fetchDashboard(from, to, hours);
}

/* =========================
          INPUT CHANGE
========================= */
fromDate.addEventListener("change", () => {
    hourSelect.value = "Custom";
    applyManual();
});

toDate.addEventListener("change", () => {
    hourSelect.value = "Custom";
    applyManual();
});

hourSelect.addEventListener("change", () => {

    // Hour-based filter selected
    if (hourSelect.value !== "Custom") {

        // Clear manual dates
        fromDate.value = "";
        toDate.value = "";

        // Save filter
        saveFilters("", "", hourSelect.value);

        // Fetch dashboard using hours
        fetchDashboard(null, null, hourSelect.value);
    }
});




/* =========================
        APPLY FILTER
========================= */
function applyManual() {
    if (fromDate.value && toDate.value) {
        saveFilters(fromDate.value, toDate.value, "Custom");
        fetchDashboard(fromDate.value, toDate.value, hourSelect.value);
    }
}

/* =========================
   DOWNLOAD AS PDF (WORKING)
========================= */
document.getElementById("dwnBtn").addEventListener("click", function () {

    const dashboard = document.getElementById("dashboardContainer");

    const fromInput = document.getElementById("fromDate").value;
    const toInput = document.getElementById("toDate").value;

    const fromVal = fromInput ? fromInput.replace("T", " ") : "N/A";
    const toVal = toInput ? toInput.replace("T", " ") : "N/A";
    const printedOn = new Date().toLocaleString();

    // Filename format
    function formatForFile(dt) {
        return dt.replace("T", "_").replace(":", "-");
    }

    const fromFile = fromInput ? formatForFile(fromInput) : "NA";
    const toFile = toInput ? formatForFile(toInput) : "NA";

    const fileName = `SKEW_Dashboard_${fromFile}_to_${toFile}.pdf`;

    // Load logo
    const logo = new Image();
    logo.src = "{{ url_for('static', filename='images/skew-logo-horizontal.png') }}";

    logo.onload = function () {

        html2canvas(dashboard, {
            scale: 2,
            useCORS: true
        }).then(canvas => {

            const pdf = new jspdf.jsPDF("p", "mm", "a4");

            const pdfWidth = 210;
            const pdfHeight = 297;

            const headerHeight = 42;
            const marginBottom = 12;

            const availableHeight = pdfHeight - headerHeight - marginBottom;

            // Original image size
            const imgWidth = pdfWidth;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            // ðŸ”¥ SCALE TO FIT ONE PAGE
            const scaleRatio = Math.min(1, availableHeight / imgHeight);
            const finalImgHeight = imgHeight * scaleRatio;
            const finalImgWidth = imgWidth * scaleRatio;

            /* =========================
                 HEADER
            ========================= */
            pdf.addImage(logo, "PNG", 10, 8, 27, 7);

            pdf.setFontSize(18);
            pdf.text("Production Dashboard Report", pdfWidth / 2, 15, {
                align: "center"
            });

            pdf.setFontSize(10);
            pdf.text(`From : ${fromVal}`, 14, 28);
            pdf.text(`To      : ${toVal}`, 14, 34);

            pdf.text(`Printed On : ${printedOn}`, pdfWidth - 14, 28, {
                align: "right"
            });

            pdf.setDrawColor(200);
            pdf.line(10, 38, pdfWidth - 10, 38);

            /* =========================
                 DASHBOARD IMAGE (ONE PAGE)
            ========================= */
            pdf.addImage(
                canvas,
                "PNG",
                (pdfWidth - finalImgWidth) / 2,  // center horizontally
                headerHeight,
                finalImgWidth,
                finalImgHeight
            );

            pdf.save(fileName);
        });
    };
});

/* =========================
    FETCH DASHBOARD DATA
========================= */
function fetchDashboard(from, to, hours) {

    let params = new URLSearchParams();

    // Custom date range
    if (hours === "Custom") {
        const start = from.replace("T", " ") + ":00";
        const end = to.replace("T", " ") + ":00";

        params.append("start_time", start);
        params.append("end_time", end);
    }
    // Hour-based filter
    else {
        params.append("hours", hours); // e.g. "1 Hr", "4 Hr"
    }

    fetch(`/api/dashboard?${params.toString()}`)
        .then(res => res.json())
        .then(api => {
            if (api.status === "error") {

                showNoData(api.message || "No data available");
                clearDashboard();
                return;
            }

            if (api.status === "success") {

                const d = api;

                updateSummary(d.summary);

                google.charts.setOnLoadCallback(() => {
                    drawLineChart(d.line_chart);
                    drawRecipeChart(d.recipe_chart);
                    drawSiloChart(d.raw_material_chart);
                    drawCalendarChart(d.calendar_chart);
                });

            }
        })
        .catch(err => {
            console.error("Dashboard fetch error:", err);
        });
}


/* =========================
        SUMMARY CARDS
========================= */
function updateSummary(s) {
    prod_today.innerText = s.total_production_tons;
    batch_count.innerText = s.num_batches;
    tph.innerText = s.tph;
    batch_acc.innerText = s.batch_accuracy + "%";
    cycle_time.innerText = s.avg_cycle_time;
}


/* =========================
          LINE CHART
========================= */
function drawLineChart(data) {

    if (!data || data.length === 0) {
        document.getElementById('lineChart').innerHTML =
            "<p style='text-align:center;color:#888;'>No data available</p>";
        return;
    }

    // ðŸ”¹ Extract unique TimeKeys and Plant Names
    const times = [...new Set(data.map(d => d.TimeKey))];
    const plants = [...new Set(data.map(d => d["Plant Name"]))];

    let table = new google.visualization.DataTable();
    table.addColumn('date', 'Time');

    // ðŸ”¹ One column per Plant â†’ legend auto generated
    plants.forEach(p => table.addColumn('number', p));

    // ðŸ”¹ Detect Hourly or Daily
    const isHourly = times[0].includes(":");

    times.forEach(t => {

        let dateObj;

        if (isHourly) {
            // Hourly â†’ today + HH:00
            const [hh] = t.split(":");
            dateObj = new Date();
            dateObj.setHours(parseInt(hh), 0, 0, 0);
        } else {
            // Daily â†’ yyyy-mm-dd
            dateObj = new Date(t);
        }

        let row = [dateObj];

        plants.forEach(p => {
            const rec = data.find(
                d => d.TimeKey === t && d["Plant Name"] === p
            );
            row.push(rec ? rec.BatchCount : 0);
        });

        table.addRow(row);
    });

    let chart = new google.visualization.LineChart(
        document.getElementById('lineChart')
    );

    chart.draw(table, {
        height: 330,
        curveType: 'function',
        pointSize: 4,
        dataOpacity: 0.9,

        legend: { position: 'top' },

        hAxis: {
            title: isHourly ? "Time" : "Date",
            slantedText: true,
            slantedTextAngle: 45,
            textStyle: { fontSize: 10 }
        },

        vAxis: {
            title: "Batch Weight (Kg)",
            viewWindow: { min: 0 },
            titleTextStyle: {
                italic: false,
                fontSize: 15,
                color: "#000"
            }
        },

        tooltip: { trigger: 'both' }
    });
}

/* =========================
         DONUT CHART
========================= */
function drawRecipeChart(data) {

    if (!data || data.length === 0) {
        document.getElementById('recipeChart').innerHTML =
            "<p style='text-align:center;color:#888;'>No data available</p>";
        return;
    }

    let table = new google.visualization.DataTable();
    table.addColumn('string', 'Recipe');
    table.addColumn('number', 'Count');

    data.forEach(r => {
        let label = `${r.RecipeName} - (${r.Count} batches)`;
        table.addRow([label, r.Count]);
    });

    let chart = new google.visualization.PieChart(document.getElementById('recipeChart'));
    chart.draw(table, {
        pieHole: 0.80,
        height: 280,
        margin: 0,
        pieSliceText: "none",
        legend: { position: 'right', alignment: 'center' }
    });
}


/* =========================
       CALENDAR CHART
========================= */
function drawCalendarChart(data) {

    if (!data || data.length === 0) {
        document.getElementById('calendarChart').innerHTML =
            "<p style='text-align:center;color:#888;'>No data available</p>";
        return;
    }

    let table = new google.visualization.DataTable();
    table.addColumn({ type: 'date', id: 'Date' });
    table.addColumn({ type: 'number', id: 'Value' });

    data.forEach(r => {
        let d = new Date(r.date);
        table.addRow([
            new Date(d.getFullYear(), d.getMonth(), d.getDate()),
            r.value
        ]);
    });

    let chart = new google.visualization.Calendar(document.getElementById('calendarChart'));

    chart.draw(table, {
        height: 350,
        calendar: {
            cellSize: 18,
            yearLabel: { fontSize: 16, color: "#444" },
            dayOfWeekLabel: { fontSize: 12 },
            monthLabel: { fontSize: 14 }
        }
    });
}


/* =========================
          BAR CHART
========================= */
function drawSiloChart(data) {

    if (!data || data.length === 0) {
        document.getElementById('siloChart').innerHTML =
            "<p style='text-align:center;color:#888;'>No data available</p>";
        return;
    }

    let table = new google.visualization.DataTable();
    table.addColumn('string', 'Category');
    table.addColumn('number', 'Actual');
    table.addColumn('number', 'Set');

    data.forEach(r => table.addRow([r.Category, r.ActualWeight, r.SetWeight]));

    let chart = new google.visualization.ColumnChart(document.getElementById('siloChart'));
    chart.draw(table, {
        height: 330,
        legend: { position: 'top' }
    });
}

window.onload = loadFilters;
</script>

{% endblock %}
