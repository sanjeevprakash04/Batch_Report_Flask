{% extends 'base.html' %}
{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">

<!-- Load Google Charts -->
<script src="https://www.gstatic.com/charts/loader.js"></script>

<div class="inv-navbar">
    <div class="inv-navbar-left">
        <span class="inv-app-title">Dashboard</span>
    </div>

    <div class="inv-navbar-right">

        <select id="hourSelect" class="inv-select">
            <option value="1 Hr">1 Hr</option>
            <option value="4 Hr">4 Hr</option>
            <option value="8 Hr">8 Hr</option>
            <option value="12 Hr">12 Hr</option>
            <option value="24 Hr">24 Hr</option>
            <option value="Custom">Custom</option>
        </select>

        <div class="date-filter">
            <span>From:</span>
            <input type="datetime-local" id="fromDate" class="inv-input">
        </div>

        <div class="date-filter">
            <span>To:</span>
            <input type="datetime-local" id="toDate" class="inv-input">
        </div>

    </div>
</div>


<!-- GRID -->
<div class="dashboard-grid">

    <!-- Summary Cards -->
    <div class="grid-item">
        <div class="summary-cards">
            <div class="card">
                <h3>Production</h3>
                <p class="value" id="prod_today">0</p>
                <span class="unit">tons</span>
            </div>

            <div class="card">
                <h3>No. of Batches</h3>
                <p class="value" id="batch_count">0</p>
            </div>

            <div class="card">
                <h3>Tons per Hour</h3>
                <p class="value" id="tph">0</p>
                <span class="unit">TPH</span>
            </div>

            <div class="card">
                <h3>Batch Accuracy</h3>
                <p class="value" id="batch_acc">0%</p>
            </div>

            <div class="card">
                <h3>Avg Batch Cycle Time</h3>
                <p class="value" id="cycle_time">0</p>
                <span class="unit">min</span>
            </div>
        </div>
    </div>

    <!-- Donut Chart -->
    <div class="grid-item">
        <div class="chart-box-recipe">
            <h3 class="chart-title">Recipe</h3>
            <div id="recipeChart"></div>
        </div>
    </div>

    <!-- Calendar Chart -->
    <div class="grid-item">
        <div class="chart-box" >
            <h3 class="chart-title">Production Calendar</h3>
            <div id="calendarChart" style="height: 350px;"></div>
        </div>
    </div>


    <!-- Line Chart -->
    <div class="grid-item">
        <div class="chart-box">
            <h3 class="chart-title">Production Line</h3>
            <div id="lineChart"></div>
        </div>
    </div>

    <!-- Bar Chart -->
    <div class="grid-item">
        <div class="chart-box">
            <h3 class="chart-title">Raw Material Consumption</h3>
            <div id="siloChart"></div>
        </div>
    </div>

</div>


<script>
google.charts.load('current', {packages: ['corechart', 'calendar']});

/* =========================
   FILTER SAVE / LOAD
========================= */
function saveFilters(from, to, hours) {
    localStorage.setItem("dash_from", from);
    localStorage.setItem("dash_to", to);
    localStorage.setItem("dash_hours", hours);
}

function loadFilters() {
    let from = localStorage.getItem("dash_from");
    let to = localStorage.getItem("dash_to");
    let hours = localStorage.getItem("dash_hours");

    if (!from || !to) {
        from = "2020-03-01T00:00";
        to = "2025-04-30T23:59";
        saveFilters(from, to, "Custom");
    }

    fromDate.value = from;
    toDate.value = to;
    hourSelect.value = hours || "Custom";
    fetchDashboard(from, to);
}

/* =========================
   USER INPUT CHANGE
========================= */
fromDate.addEventListener("change", () => {
    hourSelect.value = "Custom";
    applyManual();
});

toDate.addEventListener("change", () => {
    hourSelect.value = "Custom";
    applyManual();
});

hourSelect.addEventListener("change", () => {
    if (hourSelect.value !== "Custom") {
        fromDate.value = "";
        toDate.value = "";
    }
});

/* =========================
   APPLY FILTER
========================= */
function applyManual() {
    if (fromDate.value && toDate.value) {
        saveFilters(fromDate.value, toDate.value, "Custom");
        fetchDashboard(fromDate.value, toDate.value);
    }
}

/* =========================
   FETCH DASHBOARD DATA
========================= */
function fetchDashboard(from, to) {
    let start = from.replace("T", " ") + ":00";
    let end = to.replace("T", " ") + ":00";

    fetch(`/api/dashboard?start_time=${start}&end_time=${end}`)
        .then(res => res.json())
        .then(api => {

            if (api.status === "success") {

                const d = api;  // <<< FIXED LINE

                updateSummary(d.summary);

                google.charts.setOnLoadCallback(() => {
                    drawLineChart(d.line_chart);
                    drawRecipeChart(d.recipe_chart);
                    drawSiloChart(d.raw_material_chart);
                    drawCalendarChart(d.calendar_chart);  // <-- ADD THIS
                });

            }
        });
}

/* =========================
   SUMMARY CARDS
========================= */
function updateSummary(s) {
    prod_today.innerText = s.total_production_tons;
    batch_count.innerText = s.num_batches;
    tph.innerText = s.tph;
    batch_acc.innerText = s.batch_accuracy + "%";
    cycle_time.innerText = s.avg_cycle_time;
}

/* =========================
   LINE CHART (ERROR PROOF)
========================= */
function drawLineChart(data) {

    if (!data || data.length === 0) {
        document.getElementById('lineChart').innerHTML =
            "<p style='text-align:center;color:#888;'>No data available</p>";
        return;
    }

    let table = new google.visualization.DataTable();
    table.addColumn('date', 'Time');
    table.addColumn('number', 'Batch Weight (Kg)');

    data.forEach(r => {
        let dt = new Date(r.Hour);
        table.addRow([dt, r.BatchCount]);
    });

    let firstLabel = String(data[0].Hour);
    let isHourly = firstLabel.includes(":");
    let xTitle = isHourly ? "Time" : "Date";

    let formatter = new google.visualization.DateFormat({
        pattern: isHourly ? "HH:mm" : "MMM d yyyy"
    });
    formatter.format(table, 0);

    let interval = Math.max(1, Math.ceil(data.length / 10));

    let chart = new google.visualization.LineChart(document.getElementById('lineChart'));

    chart.draw(table, {

        curveType: 'function',
        pointSize: 5,                   // ðŸ”¥ Data point visible
        dataOpacity: 0.9,
        height: 330,

        legend: { position: 'bottom' },

        hAxis: {
            title: xTitle,
            slantedText: true,
            slantedTextAngle: 45,
            textStyle: { fontSize: 10 },
            showTextEvery: interval,
            gridlines: { count: -1 }
        },

        vAxis: {
            title: "Batch Weight (Kg)",   // ðŸ”¥ Updated label
            viewWindow: { min: 0 },
            textStyle: { fontSize: 11 }
        },

        tooltip: {
            trigger: 'both',             // ðŸ”¥ Tooltip on hover + click
            isHtml: true
        }
    });
}


/* =========================
   DONUT CHART
========================= */
function drawRecipeChart(data) {

    if (!data || data.length === 0) {
        document.getElementById('recipeChart').innerHTML =
            "<p style='text-align:center;color:#888;'>No data available</p>";
        return;
    }

    let table = new google.visualization.DataTable();
    table.addColumn('string', 'Recipe');
    table.addColumn('number', 'Count');

    data.forEach(r => {
        let label = `${r.RecipeName} - (${r.Count} batches)`;
        table.addRow([label, r.Count]);
    });


    let chart = new google.visualization.PieChart(document.getElementById('recipeChart'));
    chart.draw(table, {
        pieHole: 0.80,
        height: 330,
        pieSliceText: "none",
        legend: { position: 'right', alignment: 'center'}
        
    }
    
);
}


/* =========================
   CALENDAR CHART
========================= */

function drawCalendarChart(data) {

    if (!data || data.length === 0) {
        document.getElementById('calendarChart').innerHTML =
            "<p style='text-align:center;color:#888;'>No data available</p>";
        return;
    }

    let table = new google.visualization.DataTable();
    table.addColumn({ type: 'date', id: 'Date' });
    table.addColumn({ type: 'number', id: 'Value' });

    data.forEach(r => {
        let d = new Date(r.date);
        table.addRow([
            new Date(d.getFullYear(), d.getMonth(), d.getDate()), 
            r.value
        ]);
    });

    let chart = new google.visualization.Calendar(document.getElementById('calendarChart'));

    chart.draw(table, {
        height: 350,
        calendar: {
            cellSize: 18,
            yearLabel: { fontSize: 16, color: "#444" },
            dayOfWeekLabel: { fontSize: 12 },
            monthLabel: { fontSize: 14 }
        }
    });
}


/* =========================
   BAR CHART
========================= */
function drawSiloChart(data) {

    if (!data || data.length === 0) {
        document.getElementById('siloChart').innerHTML =
            "<p style='text-align:center;color:#888;'>No data available</p>";
        return;
    }

    let table = new google.visualization.DataTable();
    table.addColumn('string', 'Category');
    table.addColumn('number', 'Actual');
    table.addColumn('number', 'Set');

    data.forEach(r => table.addRow([r.Category, r.ActualWeight, r.SetWeight]));

    let chart = new google.visualization.ColumnChart(document.getElementById('siloChart'));
    chart.draw(table, {
        height: 330,
        legend: { position: 'top' }
    });
}

window.onload = loadFilters;
</script>

{% endblock %}
